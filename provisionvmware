---
- name: vmware provision guest
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
  - name: Create a virtual machine on given ESXi hostname
    vmware_guest:
      hostname: 172.17.1.23
      username: administrator@vsphere.local
      password: P@ssw0rd
      validate_certs: no
      folder: /PS/vm
      name: "{{ myvmname }}"
      state: poweredon
      template: cent7
      datacenter: PS
      wait_for_ip_address: yes
      state: present
    register: newvm

  - name: IP address info
    debug:
      msg: "{{ newvm.instance.ipv4 }}"

  - set_stats:
       data:
         host_list: "{{ newvm.instance.ipv4 }}"
